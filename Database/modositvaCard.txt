-- 1. Special features tábla létrehozása
CREATE TABLE IF NOT EXISTS special_features (
  id INT AUTO_INCREMENT PRIMARY KEY,
  title VARCHAR(100) NOT NULL,
  shortDescription VARCHAR(255) NOT NULL,
  icon_key VARCHAR(50) NOT NULL DEFAULT 'default'
);

-- 2. Accomodation_features kapcsolótábla létrehozása
CREATE TABLE IF NOT EXISTS accomodation_features (
  id INT AUTO_INCREMENT PRIMARY KEY,
  accomodationId INT NOT NULL,
  featureId INT NOT NULL,
  FOREIGN KEY (accomodationId) REFERENCES accomodations(id) ON DELETE CASCADE,
  FOREIGN KEY (featureId) REFERENCES special_features(id) ON DELETE CASCADE,
  UNIQUE KEY unique_accomodation_feature (accomodationId, featureId)
);

-- 3. Special features adatok beszúrása icon_key-vel
INSERT INTO special_features (title, shortDescription, icon_key) VALUES
('SZÉP kártya elfogadóhely', 'A szállás elfogadja a SZÉP kártyát.', 'card'),
('Ingyenes parkolás', 'Díjmentes parkolás biztosított.', 'parking'),
('Díjmentes Wi-Fi', 'Gyors és stabil internet mindenhol.', 'wifi'),
('Családbarát', 'Gyerekbarát szolgáltatásokkal.', 'family'),
('Állatbarát', 'Kisállat hozható a szállásra.', 'pet'),
('Reggeli igényelhető', 'Finom és friss reggeli várja a vendégeket.', 'breakfast'),
('Wellness részleg', 'Szauna, jacuzzi vagy spa szolgáltatások.', 'wellness'),
('Klimatizált szobák', 'Légkondicionált elhelyezés.', 'ac'),
('Panorámás kilátás', 'Egyedi kilátás a környékre.', 'view'),
('Kert és grillező', 'Kerti pihenő és grillezés lehetősége.', 'garden'),
('Kerékpárkölcsönzés', 'Bicikli bérelhető a helyszínen.', 'bike'),
('Önkiszolgáló check-in', 'Gyors és érintésmentes érkezés.', 'selfcheckin'),
('Beltéri medence', 'Egész évben használható medence.', 'pool'),
('Fitness terem', 'Edzési lehetőség a szállás területén.', 'gym'),
('Borkóstoló program', 'Helyi borok és borkóstoló program.', 'wine'),
('Szauna lehetőség', 'Publikus szauna lehetőség.', 'sauna');

-- 4. Procedure a random feature hozzárendeléshez
DELIMITER $$

DROP PROCEDURE IF EXISTS assign_random_features_v2$$

CREATE PROCEDURE assign_random_features_v2()
BEGIN
  DECLARE done INT DEFAULT FALSE;
  DECLARE accId INT;
  DECLARE featureCount INT;

  DECLARE cur CURSOR FOR SELECT id FROM accomodations;
  DECLARE CONTINUE HANDLER FOR NOT FOUND SET done = TRUE;

  -- Töröljük a meglévő kapcsolatokat
  DELETE FROM accomodation_features;

  OPEN cur;

  feature_loop: LOOP
    FETCH cur INTO accId;
    IF done THEN
      LEAVE feature_loop;
    END IF;

    -- 6 és 9 közötti random mennyiség
    SET featureCount = FLOOR(6 + RAND() * 4);

    -- Random feature-ök hozzárendelése
    INSERT INTO accomodation_features (accomodationId, featureId)
    SELECT accId, id
    FROM special_features
    ORDER BY RAND()
    LIMIT featureCount;

  END LOOP;

  CLOSE cur;
END$$

DELIMITER ;

-- 5. Procedure futtatása
CALL assign_random_features_v2();